package com.hjw.webService.client.xintong;

import java.awt.BorderLayout;
import java.io.File;
import java.io.FileOutputStream;
import java.io.UnsupportedEncodingException;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Date;

import javax.swing.JFrame;
import javax.swing.SwingUtilities;

import org.springframework.web.context.ContextLoader;
import org.springframework.web.context.WebApplicationContext;

import com.hjw.interfaces.HttpServer.HttpDownloader;
import com.hjw.service.ConfigService;
import com.hjw.util.DateTimeUtil;
import com.hjw.util.TranLogTxt;
import com.hjw.webService.client.Bean.PacsResult;
import com.hjw.webService.client.body.ResultPacsBody;
import com.hjw.webService.client.xintong.pacs.ResPacsMessageQH;
import com.hjw.webService.client.xintong.pacs.RetPacsCustomeQH;
import com.hjw.webService.client.xintong.pacs.RetPacsItemQH;
import com.hjw.webService.client.xintong.pacs.TestMain;
import com.hjw.wst.service.CommService;
import com.synjones.framework.persistence.JdbcQueryManager;

import chrriis.dj.nativeswing.swtimpl.NativeInterface;
import sun.misc.BASE64Decoder;
import sun.misc.BASE64Encoder;

public class PacsResMessageQH{
	
	
	 private static ConfigService configService;
	  private static JdbcQueryManager jdbcQueryManager;
	  private static CommService commService;
     static{
   	   init();
   	 }
	 public static void init(){
		WebApplicationContext wac = ContextLoader.getCurrentWebApplicationContext();
		jdbcQueryManager = (JdbcQueryManager) wac.getBean("jdbcQueryManager");
		configService = (ConfigService) wac.getBean("configService");
		commService = (CommService) wac.getBean("commService");
	 }
	
	
	/**
	 * 接受订阅报告信息 解析报告  
	 * @param url 
	 * @param logname
	 */
	 public String getMessage(String xmlMsg,String logName) {
		 
		//用本地测试
		//xmlMsg = reportXML();
		
		String result = QHResolveXML.getNodeAttVal(xmlMsg, "abc:CUST_OUT00004/abc:controlActProcess/abc:subject/abc:message_contents","val");
		TranLogTxt.liswriteEror_to_txt(logName, "----pacs结果入参---"+xmlMsg);
		String result2 = result.replaceAll("&lt;", "<");
		String resultXML = result2.replaceAll("&gt;", ">");
		
		//获取病人ID
		String exam_num =  QHResolveXML.getNodeAttVal(resultXML.trim(), "abc:ProvideAndRegisterDocumentSetRequest/abc:SourcePatientID","val");
		
		if("".equals(exam_num) || exam_num==null){
			
			return "入库失败,病人ID为空";
		}
		
		TranLogTxt.liswriteEror_to_txt(logName, "----结果exam_num---"+exam_num);
		
		//解析XML结果
		String resultBase64 = QHResolveXML.getNodeAttVal(resultXML, "abc:ProvideAndRegisterDocumentSetRequest/abc:Document/abc:Content","val");
		
		//解密 xml信息
		TranLogTxt.liswriteEror_to_txt(logName, "----解密xml报告---"+getFromBase64(resultBase64.trim()));
		
		String req_code = QHResolveXML.lisRportInfoNode(getFromBase64(resultBase64.trim()),"SQDH");
		
		TranLogTxt.liswriteEror_to_txt(logName, "----结果req_code---"+req_code);
		
		ResultPacsBody rb = insertXmlMessage(logName,getFromBase64(resultBase64.trim()), exam_num, req_code);
		
		if("AA".equals(rb.getResultHeader().getTypeCode()) && rb.getResultHeader().getTypeCode()!= null){
			return "PACS数据入库成功";
		}else{
			return "PACS数据入库失败";
		}
		
	}
	
	/**
	 * 
	 * @param xml
	 * @return
	 */
	public ResultPacsBody insertXmlMessage(String logName, String xml,String exam_num, String req_code) {
		
		TranLogTxt.liswriteEror_to_txt(logName, "----exam_num---"+exam_num+"===req_code==="+req_code);
		
		String message_id = "TJ"+DateTimeUtil.getDateTimes();
		TranLogTxt.liswriteEror_to_txt(logName, "req:" + exam_num +"---"+req_code);
		
		ResultPacsBody rb = new ResultPacsBody();
		
		//TranLogTxt.liswriteEror_to_txt(logName, "----传入xml---"+ xml);
		
			try {
				if(xml.length() > 20) {
					ResPacsMessageQH rpm = new ResPacsMessageQH(xml, true);
					RetPacsCustomeQH rc = rpm.getRetPacsCustome();
				
					PacsResult pacsResult = new PacsResult();
					pacsResult.setTil_id(logName);
					pacsResult.setExam_num(exam_num);
					pacsResult.setReq_no(req_code);
					pacsResult.setPacs_checkno(rc.getPacs_checkno());
					pacsResult.setReg_doc(rc.getReg_doc());
					pacsResult.setCheck_doc(rc.getCheck_doc());
					pacsResult.setCheck_date(rc.getCheck_date());
					pacsResult.setReport_doc(rc.getReport_doc());
					pacsResult.setReport_date(rc.getReport_date());
					pacsResult.setAudit_doc(rc.getAudit_doc());
					pacsResult.setAudit_date(rc.getAudit_date());
					String datetime = rc.getEffectiveTime().substring(0,8);
					
					RetPacsItemQH rpi = rc.getPacsItem();
					pacsResult.setClinic_symptom(rpi.getChargingItem_ms());
					pacsResult.setClinic_diagnose(rpi.getChargingItem_jl());
					pacsResult.setStudy_body_part(rpi.getBodyPart());
					pacsResult.setStudy_type(rpi.getExamMethod());
					pacsResult.setItem_name(rpi.getChargingItem_name());
					pacsResult.setPacs_item_code(rpi.getChargingItem_num());
					
					TranLogTxt.liswriteEror_to_txt(logName, "----rpi.getBase64_bg().length()---"+rpi.getBase64_bg().length());
					
					
				String dep_id = findChargingItemAndDepid(rpi.getChargingItem_num(),logName);
				String dep_num = getDepnum(dep_id,logName);
				
			//	if(dep_id.equals("199")){
					
					if (rpi.getBase64_bg().length() > 10) {
						String datatime = DateTimeUtil.shortFmt4(new Date());
						String picpath = this.commService.getDatadis("TPLJ").getName();
						File f = new File(picpath);
						if (!f.exists() && !f.isDirectory())
							f.mkdir();

						picpath = picpath + "\\pacs_img";
						String picname = "pacs_img";
						f = new File(picpath);
						if (!f.exists() && !f.isDirectory())
							f.mkdir();
						picpath = picpath + "\\" + datatime;
						picname = picname + "\\" + datatime;
						f = new File(picpath);
						if (!f.exists() && !f.isDirectory())
							f.mkdir();

						picpath = picpath + "\\" + dep_num;
						picname = picname + "\\" + dep_num;
						f = new File(picpath);
						if (!f.exists() && !f.isDirectory())
							f.mkdir();

						picpath = picpath + "\\" + exam_num;
						picname = picname + "\\" + exam_num;
						f = new File(picpath);
						if (!f.exists() && !f.isDirectory())
							f.mkdir();

						picpath = picpath + "\\" + req_code;
						picname = picname + "\\" + req_code+".jpg";
//						
						String jpgpath = picpath + ".jpg";

						FileOutputStream fos = null;
						try {
							if (new HttpDownloader(rpi.getBase64_bg(), jpgpath, logName).download()) {
								File file = new File(jpgpath);
								if (file.exists() && file.isFile()) {
									
									pacsResult.setIs_tran_image(0);
									pacsResult.setReport_img_path(picname);
									//plr.setImg_file(picname+ ".jpg");
									String fileName = file.getName();
									TranLogTxt.liswriteEror_to_txt(logName,
											"res:文件----" + fileName + "的大小是：" + file.length());
								}else{
									pacsResult.setIs_tran_image(0);
								}
							}
						} catch (Exception ex) {
							ex.printStackTrace();
						} finally {
							if (fos != null) {
								fos.close();
							}
						}
					}
				/*}else{
					
					
					
				HtmlToJpg(logName, exam_num, req_code, pacsResult, datetime, rpi);
					
					
					
				}*/
					boolean succ = this.configService.insert_pacs_result(pacsResult);
					TranLogTxt.liswriteEror_to_txt(logName, "----insert_pacs_result---"+succ);
					
					if (succ) {
						rb.getResultHeader().setTypeCode("AA");
						rb.getResultHeader().setText("交易成功");
					} else {
						rb.getResultHeader().setTypeCode("AE");
						rb.getResultHeader().setText("pacs 入库失败");
					}
				} else {
					rb.getResultHeader().setTypeCode("AE");
					rb.getResultHeader().setText("接收xml信息错误");
				}
				
			} catch (Exception ex) {
				ex.printStackTrace();
				TranLogTxt.liswriteEror_to_txt(logName, "Exception:"+com.hjw.interfaces.util.StringUtil.formatException(ex));
				rb.getResultHeader().setTypeCode("AE");
				rb.getResultHeader().setText("Exception:"+com.hjw.interfaces.util.StringUtil.formatException(ex));
			}
		return rb;
	}


	public  synchronized void HtmlToJpg(String logName, String exam_num, String req_code, PacsResult pacsResult, String datetime,
			RetPacsItemQH rpi) throws InterruptedException {
		
			 final TestMain testMain = new TestMain(rpi.getBase64_bg(), 2000, 2700,datetime,exam_num,req_code);
				String srcurl = testMain.getSrcurl();
				  NativeInterface.open();  
				    SwingUtilities.invokeLater(new Runnable() {  
				        public void run() {  
				            // SWT组件转Swing组件，不初始化父窗体将无法启动webBrowser  
				            JFrame frame = new JFrame("以DJ组件保存指定网页截图");  
				            // 加载指定页面，最大保存为640x480的截图  
				            frame.getContentPane().add(  
				            		testMain,  
				                    BorderLayout.CENTER);  
				            frame.setSize(2000, 2700);  
				            // 仅初始化，但不显示  
				            frame.invalidate();  
				            frame.pack();  
				            frame.setVisible(false);  
				        }  
				    });  
				    //NativeInterface.runEventPump();  
				    Thread.sleep(5 * 1000);
				    
				    NativeInterface.close();
				

					if (srcurl.length() > 10) {
						String picname =srcurl.replace("d:\\picture\\", ""); //PacsPictureDecodeBase64Util.decodeBase64JPG(exam_num, req_code, datetime,srcurl);
						TranLogTxt.liswriteEror_to_txt(logName, "----picname---"+srcurl+"==="+picname);
						
						pacsResult.setIs_tran_image(0);
						pacsResult.setReport_img_path(picname);
					} else {
						pacsResult.setIs_tran_image(0);
					}
		
		
	}
	
	

	/**
	 * 模拟接收XML
	 * @return
	 */
	private static String reportXML(){
		
		StringBuffer buffer = new StringBuffer();
		
		buffer.append("<?xml version=\"1.0\" encoding=\"UTF-8\"?>  ");
		buffer.append("<CUST_OUT00004 ITSVersion=\"XML_1.0\" xmlns=\"urn:hl7-org:v3\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"urn:hl7-org:v3 ../multicacheschemas/CUST_OUT00004.xsd\">  ");
		buffer.append("  <id extension=\"e02aa38f0007c3f22530\" root=\"040CD76A-ED0E-400B-9FD3-60387BCDE0EB\"/> ");
		buffer.append("  <creationTime value=\"20190212132517\"/>                                             ");
		buffer.append("  <interactionId extension=\"CUST_OUT00004\" root=\"2.16.840.1.113883.1.6\"/>            ");
		buffer.append("  <processingCode code=\"D\"/>                                                         ");
		buffer.append("  <processingModeCode/>                                                              ");
		buffer.append("  <acceptAckCode code=\"AL\"/>                                                         ");
		buffer.append("  <receiver typeCode=\"RCV\">                                                          ");
		buffer.append("    <device classCode=\"DEV\" determinerCode=\"INSTANCE\"/>                              ");
		buffer.append("  </receiver>                                                                        ");
		buffer.append("  <sender typeCode=\"SND\">                                                            ");
		buffer.append("    <device classCode=\"DEV\" determinerCode=\"INSTANCE\"/>                              ");
		buffer.append("  </sender>                                                                          ");
		buffer.append("  <acknowledgement typeCode=\"AA\">                                                    ");
		buffer.append("    <targetMessage>                                                                  ");
		buffer.append("      <id extension=\"1da0f9e0-1154-1cdc-svbe-1603d6866807\"/>                         ");
		buffer.append("    </targetMessage>                                                                 ");
		buffer.append("    <acknowledgementDetail typeCode=\"E\">                                             ");
		buffer.append("      <!--处理结果说明 -->                                                           ");
		buffer.append("      <text>                                                                         ");
		buffer.append("        <description value=\"\"/>                                                      ");
		buffer.append("      </text>                                                                        ");
		buffer.append("    </acknowledgementDetail>                                                         ");
		buffer.append("  </acknowledgement>                                                                 ");
		buffer.append("  <controlActProcess classCode=\"CACT\" moodCode=\"EVN\">                                ");
		buffer.append("    <subject>                                                                        ");
		buffer.append("      <dispatch_id>e02aa38f0006c3f22530</dispatch_id>                                ");
		buffer.append("      <sender>PACS</sender>                                                          ");
		buffer.append("      <message_id>1da0f9e0-1154-1cdc-svbe-1603d6866807</message_id>                  ");
		buffer.append("      <action>PatientRegistryFindCandidatesQuery</action>                            ");
		buffer.append("      <create_time>2019-25-12 13:25:17</create_time>                                 ");
		buffer.append("      <response_uri>HIP.PACS.QUEUE</response_uri>                                    ");
		buffer.append("      <message_contents>                                                             ");
		//message里面的内容 
		
		
		buffer.append(" &lt;ProvideAndRegisterDocumentSetRequest xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"urn:hl7-org:v3\" xsi:schemaLocation=\"urn:hl7-org:v3 ../multicacheschemas/ProvideAndRegisterDocumentSetRequest.xsd\"&gt; ");
		buffer.append("	&lt;ID root=\"请求消息OID\" extension=\"C193FE3B-E71F-4D81-8B8B-9462F35E8D38\"/&gt;                                                                   ");
		buffer.append("	&lt;SourcePatientID&gt;7760966&lt;/SourcePatientID&gt;                                                                                            ");
		buffer.append("	&lt;SourcePatientName&gt;刘永2&lt;/SourcePatientName&gt;                                                                                          ");
		buffer.append("	&lt;HealthCardId&gt;6222022320001571462&lt;/HealthCardId&gt;                                                                                      ");
		buffer.append("	&lt;IdentityId&gt;120109197706015519&lt;/IdentityId&gt;                                                                                           ");
		buffer.append("	&lt;Organization id=\"77788899922\"&gt;                                                                                                             ");
		buffer.append("		&lt;Name&gt;XX.XX&lt;/Name&gt;                                                                                                                ");
		buffer.append("		&lt;TelephoneNumber areaCode=\"028\" number=\"4448888\"/&gt;                                                                                      ");
		buffer.append("		&lt;EmailAddress address=\"XXX@yy.com.cn\"/&gt;                                                                                                 ");
		buffer.append("		&lt;Address city=\"成都\" country=\"中国\" postalCode=\"55667788\" stateOrProvince=\"四川\" street=\"青阳街\" streetNumber=\"1234\"/&gt;                  ");
		buffer.append("	&lt;/Organization&gt;                                                                                                                             ");
		buffer.append("	&lt;RegistryPackage&gt;                                                                                                                           ");
		buffer.append("		&lt;SubmissionSet targetObject=\"Document.1\" availabilityStatus=\"Submitted\"&gt;                                                                ");
		buffer.append("			&lt;SubmissionTime&gt;2012-12-14T10:11:22Z&lt;/SubmissionTime&gt;                                                                         ");
		buffer.append("			&lt;UniqueId&gt;1.3.6.1.4.1.21367.2005.3.9999.33&lt;/UniqueId&gt;                                                                         ");
		buffer.append("			&lt;SourceId&gt;3670984664&lt;/SourceId&gt;                                                                                               ");
		buffer.append("			&lt;Comments&gt;皮肤过敏，治疗药物为盐酸布替萘芬乳膏。&lt;/Comments&gt;                                                                   ");
		buffer.append("			&lt;Title&gt;会诊记录&lt;/Title&gt;                                                                                                       ");
		buffer.append("			&lt;CreateTime&gt;2012-12-13T11:32:15Z&lt;/CreateTime&gt;                                                                                 ");
		buffer.append("			&lt;ServerOrganization&gt;YYY.YY&lt;/ServerOrganization&gt;                                                                               ");
		buffer.append("			&lt;EpisodeID&gt;1111&lt;/EpisodeID&gt;                                                                                                   ");
		buffer.append("			&lt;InTime&gt;2012-12-13T11:32:15Z&lt;/InTime&gt;                                                                                         ");
		buffer.append("			&lt;OutTime&gt;2012-12-13T12:32:15Z&lt;/OutTime&gt;                                                                                       ");
		buffer.append("			&lt;AdmissionDepart&gt;皮肤科&lt;/AdmissionDepart&gt;                                                                                     ");
		buffer.append("			&lt;AdmissionDoctor&gt;李医生&lt;/AdmissionDoctor&gt;                                                                                     ");
		buffer.append("			&lt;AdmissionType&gt;门诊&lt;/AdmissionType&gt;                                                                                           ");
		buffer.append("			&lt;DiagnosisResult&gt;皮肤过敏&lt;/DiagnosisResult&gt;                                                                                   ");
		buffer.append("			&lt;Author&gt;                                                                                                                            ");
		buffer.append("				&lt;AuthorName&gt;刘善&lt;/AuthorName&gt;                                                                                             ");
		buffer.append("				&lt;AuthorInstitution&gt;XX.XX&lt;/AuthorInstitution&gt;                                                                              ");
		buffer.append("				&lt;AuthorSpecialty&gt;皮肤&lt;/AuthorSpecialty&gt;                                                                                   ");
		buffer.append("				&lt;AuthorRole&gt;三级专家&lt;/AuthorRole&gt;                                                                                         ");
		buffer.append("			&lt;/Author&gt;                                                                                                                           ");
		buffer.append("		&lt;/SubmissionSet&gt;                                                                                                                        ");
		buffer.append("	&lt;/RegistryPackage&gt;                                                                                                                          ");
		buffer.append("	&lt;Document id=\"Document.1\" mimeType=\"text/xml\" parentDocumentRelationship=\"APND\" parentDocumentId=\"AAC97D6B-75BC-4E6E-8174-EFC09C722A09\"&gt;    ");
		buffer.append("		&lt;Content&gt;                                                                            ");
		//此xml base64加密
		buffer.append(" "+reportMsgBase64()+" ");
		
		buffer.append("     &lt;/Content&gt;                                 ");
		buffer.append("	&lt;/Document&gt;                                                                                                                                  ");
		buffer.append(" &lt;/ProvideAndRegisterDocumentSetRequest&gt;                                                                                                      ");
		
		buffer.append("</message_contents>                                                                                       ");
		buffer.append("    </subject>                                                                                            ");
		buffer.append("  </controlActProcess>                                                                                    ");
		buffer.append("</CUST_OUT00004>                                                                                          ");
		TranLogTxt.liswriteEror_to_txt("XXX", "Exception:"+buffer.toString());                                                                                                                   
		return buffer.toString();
	}
	
	
	// 加密
	public static String getBase64(String str) {
		byte[] b = null;
		String s = null;
		try {
			b = str.getBytes("utf-8");
		} catch (UnsupportedEncodingException e) {
			e.printStackTrace();
		}
		if (b != null) {
			s = new BASE64Encoder().encode(b);
		}
		return s;
	}

	// 解密
	public static String getFromBase64(String s) {
		byte[] b = null;
		String result = null;
		if (s != null) {
			BASE64Decoder decoder = new BASE64Decoder();
			try {
				b = decoder.decodeBuffer(s);
				result = new String(b, "utf-8");
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
		return result;
	}
	
	
	private static String reportMsgBase64(){
		
		StringBuffer buffer = new StringBuffer();
		
		buffer.append("<ClinicalDocument xmlns=\"urn:hl7-org:v3\" xmlns:mif=\"urn:hl7-org:v3/mif\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"urn:hl7-org:v3 ..\\sdschemas\\SDA.xsd\">  ");
		buffer.append("  <realmCode code=\"CN\"/>                                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("  <typeId root=\"2.16.840.1.113883.1.3\" extension=\"POCD_MT000040\"/>                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("  <templateId root=\"2.16.156.10011.2.1.1.26\"/>                                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("  <id root=\"2.16.156.10011.1.1\" extension=\"TJ00000009\"/>                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("  <code code=\"C0006\" codeSystem=\"2.16.156.10011.2.4\" codeSystemName=\"卫生信息共享文档规范编码体系\"/>                                                                                                                                                                                                                                                                                     ");
		buffer.append("  <title>检查报告</title>                                                                                                                                                                                                                                                                                                                                                                      ");
		buffer.append("  <effectiveTime value=\"20190527000000\"/>                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("  <confidentialityCode code=\"N\" codeSystem=\"2.16.840.1.113883.5.25\" codeSystemName=\"Confidentiality\" displayName=\"正常访问保密级别\"/>                                                                                                                                                                                                                                                  ");
		buffer.append("  <languageCode code=\"zh-CN\"/>                                                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("  <setId/>                                                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("  <versionNumber/>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("  <recordTarget typeCode=\"RCT\" contextControlCode=\"OP\">                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("    <patientRole classCode=\"PAT\">                                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("      <id root=\"2.16.156.10011.1.11\" extension=\"null\"/>                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("      <id root=\"2.16.156.10011.1.12\"/>                                                                                                                                                                                                                                                                                                                                                       ");
		buffer.append("      <id root=\"2.16.156.10011.1.32\" extension=\"Y00000009588\"/>                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("      <id root=\"2.16.156.10011.1.24\" extension=\"01905270003\"/>                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("      <id root=\"2.16.156.10011.1.14\"/>                                                                                                                                                                                                                                                                                                                                                       ");
		buffer.append("      <patientType>                                                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("        <patienttypeCode codeSystem=\"2.16.156.10011.2.3.1.271\" codeSystemName=\"患者类型代码表\"/>                                                                                                                                                                                                                                                                                           ");
		buffer.append("      </patientType>                                                                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("      <telecom/>                                                                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("      <patient classCode=\"PSN\" determinerCode=\"INSTANCE\">                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("        <id root=\"2.16.156.10011.1.3\" extension=\"62220119661110061X\"/>                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("        <name>李建新</name>                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("        <administrativeGenderCode code=\"1\" displayName=\"男性\" codeSystem=\"2.16.156.10011.2.3.3.4\" codeSystemName=\"生理性别代码表(GB/T 2261.1)\"/>                                                                                                                                                                                                                                       ");
		buffer.append("        <age unit=\"岁\" value=\"52\"/>                                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("      </patient>                                                                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("    </patientRole>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("  </recordTarget>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("  <author typeCode=\"AUT\" contextControlCode=\"OP\">                                                                                                                                                                                                                                                                                                                                          ");
		buffer.append("    <time value=\"20190527\"/>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("    <assignedAuthor classCode=\"ASSIGNED\">                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("      <id root=\"2.16.156.10011.1.7\" extension=\"0000\"/>                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("      <assignedPerson>                                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("        <name>管理员</name>                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("      </assignedPerson>                                                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("    </assignedAuthor>                                                                                                                                                                                                                                                                                                                                                                          ");
		buffer.append("  </author>                                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("  <custodian typeCode=\"CST\">                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("    <assignedCustodian classCode=\"ASSIGNED\">                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("      <representedCustodianOrganization classCode=\"ORG\" determinerCode=\"INSTANCE\">                                                                                                                                                                                                                                                                                                         ");
		buffer.append("        <id root=\"2.16.156.10011.1.5\" extension=\"44000115-4\"/>                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("        <name>青海省人民医院</name>                                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("      </representedCustodianOrganization>                                                                                                                                                                                                                                                                                                                                                      ");
		buffer.append("    </assignedCustodian>                                                                                                                                                                                                                                                                                                                                                                       ");
		buffer.append("  </custodian>                                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("  <legalAuthenticator>                                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("    <time value=\"20190527000000\"/>                                                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("    <signatureCode/>                                                                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("    <assignedEntity>                                                                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("      <id root=\"2.16.156.10011.1.4\" extension=\"0000\"/>                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("      <code displayName=\"审核医师\"/>                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("      <assignedPerson classCode=\"PSN\" determinerCode=\"INSTANCE\">                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("        <name>管理员</name>                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("      </assignedPerson>                                                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("    </assignedEntity>                                                                                                                                                                                                                                                                                                                                                                          ");
		buffer.append("  </legalAuthenticator>                                                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("  <authenticator>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("    <time/>                                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("    <signatureCode/>                                                                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("    <assignedEntity>                                                                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("      <id root=\"2.16.156.10011.1.4\" extension=\"123456\"/>                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("      <code displayName=\"检查技师\"/>                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("      <assignedPerson classCode=\"PSN\" determinerCode=\"INSTANCE\">                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("        <name>没有检查技师姓名</name>                                                                                                                                                                                                                                                                                                                                                          ");
		buffer.append("      </assignedPerson>                                                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("    </assignedEntity>                                                                                                                                                                                                                                                                                                                                                                          ");
		buffer.append("  </authenticator>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("  <authenticator>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("    <time/>                                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("    <signatureCode/>                                                                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("    <assignedEntity>                                                                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("      <id root=\"2.16.156.10011.1.4\" extension=\"123456\"/>                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("      <code displayName=\"检查医师\"/>                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("      <assignedPerson classCode=\"PSN\" determinerCode=\"INSTANCE\">                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("        <name>123456</name>                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("      </assignedPerson>                                                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("    </assignedEntity>                                                                                                                                                                                                                                                                                                                                                                          ");
		buffer.append("  </authenticator>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("  <participant typeCode=\"PRF\">                                                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("    <time/>                                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("    <associatedEntity classCode=\"ASSIGNED\">                                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("      <scopingOrganization>                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("        <id root=\"2.16.156.10011.1.26\" extension=\"27\"/>                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("        <name>体检中心</name>                                                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("        <asOrganizationPartOf>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("          <wholeOrganization>                                                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("            <id root=\"2.16.156.10011.1.5\" extension=\"44000115-4\"/>                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("            <name>青海省人民医院</name>                                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("          </wholeOrganization>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("        </asOrganizationPartOf>                                                                                                                                                                                                                                                                                                                                                                ");
		buffer.append("      </scopingOrganization>                                                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("    </associatedEntity>                                                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("  </participant>                                                                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("  <relatedDocument typeCode=\"RPLC\">                                                                                                                                                                                                                                                                                                                                                          ");
		buffer.append("    <parentDocument>                                                                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("      <id/>                                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("      <setId/>                                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("      <versionNumber/>                                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("    </parentDocument>                                                                                                                                                                                                                                                                                                                                                                          ");
		buffer.append("  </relatedDocument>                                                                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("  <componentOf>                                                                                                                                                                                                                                                                                                                                                                                ");
		buffer.append("    <encompassingEncounter>                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("      <effectiveTime/>                                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("      <location>                                                                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("        <healthCareFacility>                                                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("          <serviceProviderOrganization>                                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("            <asOrganizationPartOf classCode=\"PART\">                                                                                                                                                                                                                                                                                                                                          ");
		buffer.append("              <wholeOrganization classCode=\"ORG\" determinerCode=\"INSTANCE\">                                                                                                                                                                                                                                                                                                                ");
		buffer.append("                <id root=\"2.16.156.10011.1.22\"/>                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("                <asOrganizationPartOf classCode=\"PART\">                                                                                                                                                                                                                                                                                                                                      ");
		buffer.append("                  <wholeOrganization classCode=\"ORG\" determinerCode=\"INSTANCE\">                                                                                                                                                                                                                                                                                                            ");
		buffer.append("                    <id root=\"2.16.156.10011.1.21\"/>                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("                    <asOrganizationPartOf classCode=\"PART\">                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("                      <wholeOrganization classCode=\"ORG\" determinerCode=\"INSTANCE\">                                                                                                                                                                                                                                                                                                        ");
		buffer.append("                        <id root=\"2.16.156.10011.1.26\"/>                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("                        <name/>                                                                                                                                                                                                                                                                                                                                                                ");
		buffer.append("                        <asOrganizationPartOf classCode=\"PART\">                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("                          <wholeOrganization classCode=\"ORG\" determinerCode=\"INSTANCE\">                                                                                                                                                                                                                                                                                                    ");
		buffer.append("                            <id root=\"2.16.156.10011.1.27\"/>                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("                            <name/>                                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("                            <asOrganizationPartOf classCode=\"PART\">                                                                                                                                                                                                                                                                                                                          ");
		buffer.append("                              <wholeOrganization classCode=\"ORG\" determinerCode=\"INSTANCE\">                                                                                                                                                                                                                                                                                                ");
		buffer.append("                                <id root=\"2.16.156.10011.1.5\"/>                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("                                <name/>                                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("                              </wholeOrganization>                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("                            </asOrganizationPartOf>                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("                          </wholeOrganization>                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("                        </asOrganizationPartOf>                                                                                                                                                                                                                                                                                                                                                ");
		buffer.append("                      </wholeOrganization>                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("                    </asOrganizationPartOf>                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("                  </wholeOrganization>                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("                </asOrganizationPartOf>                                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("              </wholeOrganization>                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("            </asOrganizationPartOf>                                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("          </serviceProviderOrganization>                                                                                                                                                                                                                                                                                                                                                       ");
		buffer.append("        </healthCareFacility>                                                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("      </location>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("    </encompassingEncounter>                                                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("  </componentOf>                                                                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("  <component>                                                                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("    <structuredBody>                                                                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("      <component>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("        <section>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("          <code code=\"29548-5\" displayName=\"Diagnosis\" codeSystem=\"2.16.840.1.113883.6.1\" codeSystemName=\"LOINC\"/>                                                                                                                                                                                                                                                                     ");
		buffer.append("          <text/>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("          <entry>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("            <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("              <code code=\"DE05.01.024.00\" displayName=\"诊断代码\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\"/>                                                                                                                                                                                                                                               ");
		buffer.append("              <effectiveTime value=\"20190201\"/>                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("              <value xsi:type=\"CD\" code=\"Z10.100\" displayName=\"健康体检\" codeSystem=\"2.16.156.10011.2.3.3.11\" codeSystemName=\"ICD-10\"/>                                                                                                                                                                                                                                              ");
		buffer.append("              <performer>                                                                                                                                                                                                                                                                                                                                                                      ");
		buffer.append("                <assignedEntity>                                                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("                  <id/>                                                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("                  <representedOrganization>                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("                    <name>青海省人民医院</name>                                                                                                                                                                                                                                                                                                                                                ");
		buffer.append("                  </representedOrganization>                                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("                </assignedEntity>                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("              </performer>                                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("            </observation>                                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("          </entry>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("        </section>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("      </component>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("      <component>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("        <section>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("          <code code=\"10154-3\" displayName=\"CHIEF COMPLAINT\" codeSystem=\"2.16.840.1.113883.6.1\" codeSystemName=\"LOINC\"/>                                                                                                                                                                                                                                                               ");
		buffer.append("          <text/>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("          <entry>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("            <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("              <code code=\"DE04.01.119.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"主诉\"/>                                                                                                                                                                                                                                                   ");
		buffer.append("              <value xsi:type=\"ST\">公共机构居民的常规一般性健康查体</value>                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("            </observation>                                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("          </entry>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("        </section>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("      </component>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("      <component>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("        <section>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("          <code code=\"11450-4\" codeSystem=\"2.16.840.1.113883.6.1\" codeSystemName=\"LOINC\" displayName=\"PROBLEM LIST\"/>                                                                                                                                                                                                                                                                  ");
		buffer.append("          <text/>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("          <entry>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("            <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("              <code code=\"DE04.01.117.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"症状描述\"/>                                                                                                                                                                                                                                               ");
		buffer.append("              <effectiveTime>                                                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("                <low value=\"20190202\"/>                                                                                                                                                                                                                                                                                                                                                      ");
		buffer.append("                <high value=\"20190208\"/>                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("              </effectiveTime>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("              <value xsi:type=\"ST\">公共机构居民的常规一般性健康查体</value>                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("            </observation>                                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("          </entry>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("        </section>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("      </component>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("      <component>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("        <section>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("          <code code=\"47519-4\" displayName=\"HISTORY OF PROCEDURES\" codeSystem=\"2.16.840.1.113883.6.1\" codeSystemName=\"LOINC\"/>                                                                                                                                                                                                                                                         ");
		buffer.append("          <text/>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("          <entry>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("            <procedure classCode=\"PROC\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("              <code codeSystem=\"2.16.156.10011.2.3.3.12\" codeSystemName=\"ICD-9-CM-3\"/>                                                                                                                                                                                                                                                                                                     ");
		buffer.append("              <statusCode/>                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("              <effectiveTime/>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("              <targetSiteCode codeSystem=\"2.16.156.10011.2.3.1.266\" codeSystemName=\"操作部位代码表\"/>                                                                                                                                                                                                                                                                                      ");
		buffer.append("              <entryRelationship typeCode=\"COMP\">                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("                <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("                  <code code=\"DE06.00.094.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"手术（操作）名称\"/>                                                                                                                                                                                                                                   ");
		buffer.append("                  <value xsi:type=\"ST\"/>                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("                </observation>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("              </entryRelationship>                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("              <entryRelationship typeCode=\"COMP\">                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("                <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("                  <code code=\"DE08.50.037.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"介入物名称\"/>                                                                                                                                                                                                                                         ");
		buffer.append("                  <value xsi:type=\"ST\"/>                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("                </observation>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("              </entryRelationship>                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("              <entryRelationship typeCode=\"COMP\">                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("                <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("                  <code code=\"DE06.00.251.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"操作方法描述\"/>                                                                                                                                                                                                                                       ");
		buffer.append("                  <value xsi:type=\"ST\"/>                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("                </observation>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("              </entryRelationship>                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("              <entryRelationship typeCode=\"COMP\">                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("                <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("                  <code code=\"DE06.00.250.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"操作次数\"/>                                                                                                                                                                                                                                           ");
		buffer.append("                  <value xsi:type=\"ST\">12</value>                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("                </observation>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("              </entryRelationship>                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("              <entryRelationship typeCode=\"COMP\">                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("                <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("                  <code code=\"DE06.00.073.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"麻醉方式代码\"/>                                                                                                                                                                                                                                       ");
		buffer.append("                  <value codeSystem=\"2.16.156.10011.2.3.1.159\" codeSystemName=\"麻醉方法代码表\" xsi:type=\"CD\"/>                                                                                                                                                                                                                                                                           ");
		buffer.append("                  <performer>                                                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("                    <assignedEntity>                                                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("                      <id/>                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("                      <assignedPerson>                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("                        <name/>                                                                                                                                                                                                                                                                                                                                                                ");
		buffer.append("                      </assignedPerson>                                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("                    </assignedEntity>                                                                                                                                                                                                                                                                                                                                                          ");
		buffer.append("                  </performer>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("                </observation>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("              </entryRelationship>                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("              <entryRelationship typeCode=\"COMP\">                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("                <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("                  <code code=\"DE02.10.028.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"麻醉观察结果\"/>                                                                                                                                                                                                                                       ");
		buffer.append("                  <value xsi:type=\"ST\"/>                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("                </observation>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("              </entryRelationship>                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("              <entryRelationship typeCode=\"COMP\">                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("                <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("                  <code code=\"DE06.00.307.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"麻醉中西医标识代码\"/>                                                                                                                                                                                                                                 ");
		buffer.append("                  <value codeSystem=\"2.16.156.10011.2.3.2.41\" codeSystemName=\"麻醉中西医标识代码表\" xsi:type=\"CD\"/>                                                                                                                                                                                                                                                                      ");
		buffer.append("                </observation>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("              </entryRelationship>                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("            </procedure>                                                                                                                                                                                                                                                                                                                                                                       ");
		buffer.append("          </entry>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("        </section>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("      </component>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("      <component>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("        <section>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("          <code code=\"29545-1\" displayName=\"PHYSICAL EXAMINATION\" codeSystem=\"2.16.840.1.113883.6.1\" codeSystemName=\"LOINC\"/>                                                                                                                                                                                                                                                          ");
		buffer.append("          <text/>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("          <entry>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("            <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("              <code code=\"DE02.01.079.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"特殊检查标志\"/>                                                                                                                                                                                                                                           ");
		buffer.append("              <value xsi:type=\"ST\">F</value>                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("            </observation>                                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("          </entry>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("          <entry>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("            <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("              <code code=\"DE02.10.027.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"检查方法名称\"/>                                                                                                                                                                                                                                           ");
		buffer.append("              <value xsi:type=\"ST\">null；</value>                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("            </observation>                                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("          </entry>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("          <entry>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("            <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("              <code code=\"DE04.30.018.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"检查类别\"/>                                                                                                                                                                                                                                               ");
		buffer.append("              <value xsi:type=\"ST\">US</value>                                                                                                                                                                                                                                                                                                                                                ");
		buffer.append("            </observation>                                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("          </entry>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("          <entry>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("            <organizer classCode=\"CLUSTER\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("              <statusCode/>                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("              <component>                                                                                                                                                                                                                                                                                                                                                                      ");
		buffer.append("                <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("                  <code code=\"DE04.30.019.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"检查项目代码\"/>                                                                                                                                                                                                                                       ");
		buffer.append("                  <effectiveTime value=\"20190418\"/>                                                                                                                                                                                                                                                                                                                                          ");
		buffer.append("                  <value xsi:type=\"ST\">C0004030|甲状腺及颈部淋巴结彩超</value>                                                                                                                                                                                                                                                                                                               ");
		buffer.append("                  <entryRelationship typeCode=\"COMP\">                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("                    <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("                      <code code=\"DE04.50.134.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"标本类别\"/>                                                                                                                                                                                                                                       ");
		buffer.append("                      <effectiveTime>                                                                                                                                                                                                                                                                                                                                                          ");
		buffer.append("                        <low value=\"20130101110103\"/>                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("                        <high value=\"20130102110212\"/>                                                                                                                                                                                                                                                                                                                                       ");
		buffer.append("                      </effectiveTime>                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("                      <value xsi:type=\"ST\">标本类别</value>                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("                    </observation>                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("                  </entryRelationship>                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("                  <entryRelationship typeCode=\"COMP\">                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("                    <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("                      <code code=\"DE04.50.135.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"标本状态\"/>                                                                                                                                                                                                                                       ");
		buffer.append("                      <value xsi:type=\"ST\">标本状态</value>                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("                    </observation>                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("                  </entryRelationship>                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("                  <entryRelationship typeCode=\"COMP\">                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("                    <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("                      <code code=\"DE08.50.027.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"标本固定液名称\"/>                                                                                                                                                                                                                                 ");
		buffer.append("                      <value xsi:type=\"ST\">标本固定液名称</value>                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("                    </observation>                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("                  </entryRelationship>                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("                </observation>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("              </component>                                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("              <component>                                                                                                                                                                                                                                                                                                                                                                      ");
		buffer.append("                <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("                  <code code=\"DE04.30.017.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"检查结果代码\"/>                                                                                                                                                                                                                                       ");
		buffer.append("                  <value xsi:type=\"CD\" code=\"1\" displayName=\"异常\" codeSystem=\"2.16.156.10011.2.3.2.38\" codeSystemName=\"检查/检验结果代码表\"/>                                                                                                                                                                                                                                       ");
		buffer.append("                </observation>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("              </component>                                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("              <component>                                                                                                                                                                                                                                                                                                                                                                      ");
		buffer.append("                <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                               ");
		buffer.append("                  <code code=\"DE04.30.015.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"检查定量结果\"/>                                                                                                                                                                                                                                       ");
		buffer.append("                  <value xsi:type=\"REAL\" value=\"1.7777\"/>                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("                  <entryRelationship typeCode=\"COMP\">                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("                    <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("                      <code code=\"DE04.30.016.00\" displayName=\"检查定量结果计量单位\" codeSystemName=\"卫生信息数据元目录\" codeSystem=\"2.16.156.10011.2.2.1\"/>                                                                                                                                                                                                                           ");
		buffer.append("                      <value xsi:type=\"ST\">ml</value>                                                                                                                                                                                                                                                                                                                                        ");
		buffer.append("                    </observation>                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("                  </entryRelationship>                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("                </observation>                                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("              </component>                                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("            </organizer>                                                                                                                                                                                                                                                                                                                                                                       ");
		buffer.append("          </entry>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("        </section>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("      </component>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("      <component>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("        <section>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("          <code displayName=\"其他处置章节\"/>                                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("          <text/>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("          <entry typeCode=\"COMP\">                                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("            <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("              <code code=\"DE06.00.296.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"诊疗过程描述\"/>                                                                                                                                                                                                                                           ");
		buffer.append("              <value xsi:type=\"ST\"/>                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("            </observation>                                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("          </entry>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("        </section>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("      </component>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("      <component>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("        <section>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("          <code displayName=\"检查报告\"/>                                                                                                                                                                                                                                                                                                                                                     ");
		buffer.append("          <text>Jcbg2Html/2019/05/27/Y00000009588/Y00000009588_李建新_男_2656977.html</text>                                                                                                                                                                                                                                                                                                   ");
		buffer.append("          <entry>                                                                                                                                                                                                                                                                                                                                                                              ");
		buffer.append("            <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("              <code code=\"DE04.50.131.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"检查报告结果-客观所见\"/>                                                                                                                                                                                                                                  ");
		buffer.append("              <value xsi:type=\"ST\">肝脏：形态大小正常，边缘光整，实质回声均匀，肝内胆管不扩张，肝内管道走行自然，门静脉主干内径约 8 mm。 胆囊：大小正常，囊壁光滑，囊内透声好，胆总管内径 4 mm。 胰腺：形态大小正常，回声均匀，主胰管无扩张。 脾脏：形态大小正常，脾脏实质内回声均匀。 双肾：轮廓清晰，被膜完整，形态正常，肾实质回声均匀，双肾集合系统无分离。 CDFI:血流未见异常。</value>  ");
		buffer.append("            </observation>                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("          </entry>                                                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("          <entry>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("            <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("              <code code=\"DE04.50.132.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"检查报告结果-主观提示\"/>                                                                                                                                                                                                                                 ");
		buffer.append("              <value xsi:type=\"ST\">肝、胆、胰、脾、双肾未见明显异常</value>                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("            </observation>                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("          </entry>                                                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("          <entry>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("            <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("              <code code=\"DE08.10.026.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"检查报告科室\"/>                                                                                                                                                                                                                                          ");
		buffer.append("              <value xsi:type=\"ST\">null</value>                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("            </observation>                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("          </entry>                                                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("          <entry>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("            <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("              <code code=\"DE08.10.013.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"检查报告机构名称\"/>                                                                                                                                                                                                                                      ");
		buffer.append("              <value xsi:type=\"ST\">青海省人民医院</value>                                                                                                                                                                                                                                                                                                                                   ");
		buffer.append("            </observation>                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("          </entry>                                                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("          <entry>                                                                                                                                                                                                                                                                                                                                                                             ");
		buffer.append("            <observation classCode=\"OBS\" moodCode=\"EVN\">                                                                                                                                                                                                                                                                                                                                  ");
		buffer.append("              <code code=\"DE06.00.179.00\" codeSystem=\"2.16.156.10011.2.2.1\" codeSystemName=\"卫生信息数据元目录\" displayName=\"检查报告备注\"/>                                                                                                                                                                                                                                          ");
		buffer.append("              <value xsi:type=\"ST\">检查报告备注信息</value>                                                                                                                                                                                                                                                                                                                                 ");
		buffer.append("            </observation>                                                                                                                                                                                                                                                                                                                                                                    ");
		buffer.append("          </entry>                                                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("        </section>                                                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("      </component>                                                                                                                                                                                                                                                                                                                                                                            ");
		buffer.append("    </structuredBody>                                                                                                                                                                                                                                                                                                                                                                         ");
		buffer.append("  </component>                                                                                                                                                                                                                                                                                                                                                                                ");
		buffer.append("</ClinicalDocument>                                                                                                                                                                                                                                                                                                                                                                           ");
		buffer.append("                                                                                                                                                                                                                                                                                                                                                                                              ");

		//返回加密数据
		return getBase64(buffer.toString().trim());                                                                                                                                                                                              
		
	}                
	
	private String findChargingItemAndDepid(String chargingItem_num, String logName) {
		Connection tjtmpconnect = null;
		String dep_id = null;
		try {
			tjtmpconnect = this.jdbcQueryManager.getConnection();
			String sql  = " select  dep_id from charging_item where his_num='"+chargingItem_num+"' and isActive='Y' and his_num !='' and his_num is not null ";
			 TranLogTxt.liswriteEror_to_txt(logName, "res:" + sql + "\r\n");
			ResultSet rs1 = tjtmpconnect.createStatement().executeQuery(sql);
			if (rs1.next()) {
				int depid = rs1.getInt("dep_id");
				dep_id=depid+"";
			}
			rs1.close();
        }catch(Exception ex){
			
		}finally {
			try {
				if (tjtmpconnect != null) {
					tjtmpconnect.close();
				}
			} catch (SQLException sqle4) {
				sqle4.printStackTrace();
			}
		}
		
		
		
		return dep_id;
	}
	
	private String getDepnum(String dep_id, String logName) {
		Connection tjtmpconnect = null;
		String dep_num = null;
		try {
			tjtmpconnect = this.jdbcQueryManager.getConnection();
			String sql  = " select dep_num from department_dep where id='"+dep_id+"' and isActive='Y' ";
			 TranLogTxt.liswriteEror_to_txt(logName, "res:" + sql + "\r\n");
			ResultSet rs1 = tjtmpconnect.createStatement().executeQuery(sql);
			if (rs1.next()) {
				dep_num = rs1.getString("dep_num");
			}
			rs1.close();
        }catch(Exception ex){
			
		}finally {
			try {
				if (tjtmpconnect != null) {
					tjtmpconnect.close();
				}
			} catch (SQLException sqle4) {
				sqle4.printStackTrace();
			}
		}
		
		
		return dep_num;
	}


	                                                                                                                                                                                               
}                                                                                                                                                                                                     
